<ion-content class="reserva-page ion-padding">
  <div class="reserva-container">

    <!-- NAVBAR -->
    <div class="navbar">
      <div class="nav-logo">
        <img src="./../../assets/Img/logo3.png" alt="Logo Veterinaria" />
        <span>Veterinaria Pucará</span>
      </div>

      <div class="nav-links">
        <a routerLink="/">Inicio</a>
        <a routerLink="/blog">Blog</a>
        <a routerLink="/nosotros">Nosotros</a>
        <a routerLink="/contacto">Contacto</a>
        <ion-button color="success" routerLink="/reserva">Reserva tu hora</ion-button>
      </div>
    </div>

    <!-- CONTENIDO -->
    <main class="contenido">

      <!-- PASOS -->
      <ion-segment [(ngModel)]="paso" value="servicio" mode="ios">
        <ion-segment-button value="servicio"><ion-label>1. Servicio</ion-label></ion-segment-button>
        <ion-segment-button value="fecha"><ion-label>2. Fecha y hora</ion-label></ion-segment-button>
        <ion-segment-button value="profesional"><ion-label>3. Profesional</ion-label></ion-segment-button>
        <ion-segment-button value="datos"><ion-label>4. Datos</ion-label></ion-segment-button>
      </ion-segment>

      <!-- ===================== PASO 1: SERVICIO ===================== -->
      <div *ngIf="paso === 'servicio'" class="paso">
        <h2>Selecciona un servicio veterinario</h2>

        <ion-grid>
          <ion-row>
            <ion-col size="12" size-md="6" *ngFor="let s of servicios">
              <ion-card
                (click)="seleccionarServicio(s.ID_SERVICIO || s.id_servicio)"
                [class.selected]="cita.id_servicio === (s.ID_SERVICIO || s.id_servicio)"
              >
                <ion-card-header>
                  <ion-card-title>
                    {{ s.NOMBRE_SERVICIO || s.nombre_servicio }}
                  </ion-card-title>
                </ion-card-header>

                <ion-card-content>
                  <p>{{ s.DESCRIPCION || s.descripcion }}</p>
                  <p><strong>Precio:</strong> ${{ s.PRECIO || s.precio }}</p>
                  <p><strong>Duración:</strong> {{ s.DURACION_MINUTOS }} min</p>
                </ion-card-content>
              </ion-card>
            </ion-col>
          </ion-row>
        </ion-grid>
      </div>

      <!-- ===================== PASO 2: FECHA ===================== -->
      <div *ngIf="paso === 'fecha'" class="paso">
        <h2>Selecciona fecha y hora</h2>

        <ion-datetime
          presentation="date"
          [(ngModel)]="fechaSeleccionada"
          (ionChange)="cargarHorasDisponibles()"
          [min]="today">
        </ion-datetime>

        <div *ngIf="horasDisponibles.length > 0; else noHoras">
          <ion-item>
            <ion-label>Hora</ion-label>
            <ion-select [(ngModel)]="horaSeleccionada" placeholder="Seleccione hora">
              <ion-select-option *ngFor="let hora of horasDisponibles" [value]="hora">
                {{ hora }}
              </ion-select-option>
            </ion-select>
          </ion-item>
        </div>

        <ng-template #noHoras>
          <p>No hay horas disponibles para esta fecha.</p>
        </ng-template>

        <ion-button expand="block" (click)="continuarFecha()">Continuar</ion-button>
      </div>

      <!-- ===================== PASO 3: PROFESIONAL ===================== -->
      <div *ngIf="paso === 'profesional'" class="paso">
        <h2>Selecciona el profesional</h2>

        <ion-list *ngIf="profesionales.length > 0; else sinProfesionales">
          <ion-item button *ngFor="let p of profesionales" (click)="seleccionarProfesional(p)">
            <ion-label>
              {{ p.NOMBRE }} {{ p.APELLIDO }}
              <div style="font-size: 0.9rem">
                <span *ngIf="p.TELEFONO">Tel: {{ p.TELEFONO }}</span><br />
                <span *ngIf="p.EMAIL">Email: {{ p.EMAIL }}</span>
              </div>
            </ion-label>
          </ion-item>
        </ion-list>

        <ng-template #sinProfesionales>
          <p>No hay profesionales disponibles.</p>
        </ng-template>
      </div>

      <!-- ===================== PASO 4: DATOS ===================== -->
      <div *ngIf="paso === 'datos'" class="paso">
        <h2>Datos del propietario y mascota</h2>

        <form [formGroup]="formDatos">

          <ion-item>
            <ion-input label="Nombre" formControlName="nombre"></ion-input>
          </ion-item>
          <p class="error" *ngIf="formDatos.get('nombre')?.touched && formDatos.get('nombre')?.invalid">
            ❌ Debes ingresar un nombre.
          </p>

          <ion-item>
            <ion-input label="Apellido" formControlName="apellido"></ion-input>
          </ion-item>
          <p class="error" *ngIf="formDatos.get('apellido')?.touched && formDatos.get('apellido')?.invalid">
            ❌ Debes ingresar un apellido.
          </p>

          <ion-item>
            <ion-input label="RUT" formControlName="rut"></ion-input>
          </ion-item>
          <p class="error" *ngIf="formDatos.get('rut')?.errors?.['rutInvalido']">
            ❌ RUT inválido. Ej: 12345678-5
          </p>

          <ion-item>
            <ion-input label="Teléfono" formControlName="telefono"></ion-input>
          </ion-item>
          <p class="error" *ngIf="formDatos.get('telefono')?.invalid && formDatos.get('telefono')?.touched">
            ❌ El teléfono debe tener 9 dígitos.
          </p>

          <ion-item>
            <ion-input label="Email" formControlName="email"></ion-input>
          </ion-item>
          <p class="error" *ngIf="formDatos.get('email')?.invalid && formDatos.get('email')?.touched">
            ❌ Ingresa un correo válido.
          </p>

          <ion-item>
            <ion-input label="Nombre de la mascota" formControlName="nombre_mascota"></ion-input>
          </ion-item>

          <ion-item>
            <ion-input label="Raza" formControlName="raza"></ion-input>
          </ion-item>

          <ion-item>
            <ion-input label="Tipo de mascota" formControlName="tipo_mascota"></ion-input>
          </ion-item>

          <ion-button expand="block" color="success" [disabled]="formDatos.invalid" (click)="reservar()">
            Confirmar Reserva
          </ion-button>

        </form>
      </div>

    </main>

    <!-- FOOTER -->
    <footer>
      <div class="footer-content">
        <div>
          <h4>Información</h4>
          <ul>
            <li><a href="#">Nuestra Clínica</a></li>
            <li><a href="#">Preguntas Frecuentes</a></li>
            <li><a routerLink="/admin-login">Ingreso Admin</a></li>
          </ul>
        </div>

        <div>
          <h4>Políticas</h4>
          <ul>
            <li><a href="#">Privacidad</a></li>
            <li><a href="#">Términos y Condiciones</a></li>
          </ul>
        </div>

        <div>
          <h4>Contáctanos</h4>
          <p>contacto@veterinaria.cl</p>
          <p>+56 2 2859 2840</p>
        </div>
      </div>

      <div class="footer-bottom">
        © 2025 Clínica Veterinaria Pucará. Todos los derechos reservados.
      </div>
    </footer>

  </div>
</ion-content>
